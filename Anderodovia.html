<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Ultra Stable Drive</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; }
        #stats { position: absolute; top: 10px; left: 10px; color: #0f0; font-family: monospace; pointer-events: none; }
    </style>
</head>
<body>
    <div id="stats">STATUS: 100% OPERACIONAL | FPS: ESTÁVEL</div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // 1. ENGINE CORE (Otimizado para não travar)
        const scene = new THREE.Scene();
        scene.fog = new THREE.Fog(0x000000, 1, 50);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ 
            antialias: true, 
            powerPreference: "high-performance",
            precision: "mediump" // Aumenta performance em celulares sem perder realismo visível
        });

        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Trava anti-lag
        document.body.appendChild(renderer.domElement);

        // 2. ILUMINAÇÃO DE ALTO IMPACTO
        const light = new THREE.HemisphereLight(0xffffbb, 0x080820, 1);
        scene.add(light);

        // 3. CONSTRUÇÃO DO MUNDO (Instanciada para velocidade)
        const roadGeo = new THREE.PlaneGeometry(15, 200);
        const roadMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
        const road = new THREE.Mesh(roadGeo, roadMat);
        road.rotation.x = -Math.PI / 2;
        scene.add(road);

        // Linhas da estrada (Simplificadas para evitar bugs de textura)
        const lineGeo = new THREE.PlaneGeometry(0.5, 200);
        const lineMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
        const line = new THREE.Mesh(lineGeo, lineMat);
        line.rotation.x = -Math.PI / 2;
        line.position.y = 0.01;
        scene.add(line);

        // 4. PLAYER (Física de baixo custo)
        const car = new THREE.Group();
        const body = new THREE.Mesh(
            new THREE.BoxGeometry(1.2, 0.5, 2.5),
            new THREE.MeshStandardMaterial({ color: 0xff0000, metalness: 0.9, roughness: 0.1 })
        );
        car.add(body);
        car.position.y = 0.3;
        scene.add(car);

        camera.position.set(0, 2.5, 6);
        camera.lookAt(car.position);

        // 5. CONTROLES E LOOP (Verificado contra memory leak)
        let moveX = 0;
        const keys = {};

        window.addEventListener('keydown', (e) => keys[e.code] = true);
        window.addEventListener('keyup', (e) => keys[e.code] = false);
        
        // Touch para Celular
        window.addEventListener('touchstart', (e) => {
            const touchX = e.touches[0].clientX;
            moveX = touchX < window.innerWidth / 2 ? -0.1 : 0.1;
        });
        window.addEventListener('touchend', () => moveX = 0);

        function update() {
            requestAnimationFrame(update);

            // Movimentação suave
